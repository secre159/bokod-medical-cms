<?php

echo "üöÄ Starting Production Messaging Database Fix...\n\n";

try {
    // Check if we're in Laravel environment
    if (!defined('LARAVEL_START')) {
        require_once __DIR__ . '/vendor/autoload.php';
        $app = require_once __DIR__ . '/bootstrap/app.php';
        $app->make(Illuminate\Contracts\Console\Kernel::class)->bootstrap();
    }

    // Use Laravel's database connection
    $connection = DB::connection();
    $databaseName = $connection->getDatabaseName();
    
    echo "üìä Connected to database: {$databaseName}\n";
    echo "üîó Connection type: " . get_class($connection) . "\n\n";

    // Check if messaging tables exist
    echo "üîç Checking messaging tables...\n";
    
    $tables = ['conversations', 'messages'];
    $existingTables = [];
    
    foreach ($tables as $table) {
        if (Schema::hasTable($table)) {
            $existingTables[] = $table;
            echo "  ‚úÖ {$table} table exists\n";
        } else {
            echo "  ‚ùå {$table} table MISSING\n";
        }
    }
    
    if (empty($existingTables)) {
        echo "\nüö® CRITICAL: No messaging tables found!\n";
        echo "üí° Run: php artisan migrate\n";
        exit(1);
    }
    
    echo "\nüîç Checking messages table structure...\n";
    
    // Check messages table columns
    $columns = Schema::getColumnListing('messages');
    $requiredColumns = [
        'id', 'conversation_id', 'sender_id', 'message', 'message_type', 
        'priority', 'has_attachment', 'file_path', 'file_name', 'file_type', 
        'mime_type', 'file_size', 'reactions', 'created_at', 'updated_at'
    ];
    
    $missingColumns = [];
    
    foreach ($requiredColumns as $column) {
        if (in_array($column, $columns)) {
            echo "  ‚úÖ {$column} column exists\n";
        } else {
            $missingColumns[] = $column;
            echo "  ‚ùå {$column} column MISSING\n";
        }
    }
    
    if (!empty($missingColumns)) {
        echo "\nüîß Adding missing columns...\n";
        
        foreach ($missingColumns as $column) {
            try {
                switch ($column) {
                    case 'reactions':
                        Schema::table('messages', function ($table) {
                            $table->json('reactions')->nullable();
                        });
                        echo "  ‚úÖ Added {$column} column\n";
                        break;
                    
                    case 'has_attachment':
                        Schema::table('messages', function ($table) {
                            $table->boolean('has_attachment')->default(false);
                        });
                        echo "  ‚úÖ Added {$column} column\n";
                        break;
                    
                    case 'file_path':
                    case 'file_name':
                    case 'file_type':
                    case 'mime_type':
                        Schema::table('messages', function ($table) use ($column) {
                            $table->string($column)->nullable();
                        });
                        echo "  ‚úÖ Added {$column} column\n";
                        break;
                    
                    case 'file_size':
                        Schema::table('messages', function ($table) {
                            $table->bigInteger('file_size')->nullable();
                        });
                        echo "  ‚úÖ Added {$column} column\n";
                        break;
                    
                    case 'priority':
                        Schema::table('messages', function ($table) {
                            $table->enum('priority', ['low', 'normal', 'urgent'])->default('normal');
                        });
                        echo "  ‚úÖ Added {$column} column\n";
                        break;
                    
                    case 'message_type':
                        Schema::table('messages', function ($table) {
                            $table->enum('message_type', ['text', 'image', 'file', 'system'])->default('text');
                        });
                        echo "  ‚úÖ Added {$column} column\n";
                        break;
                    
                    default:
                        echo "  ‚ö†Ô∏è  Skipped {$column} - manual intervention needed\n";
                        break;
                }
            } catch (Exception $e) {
                echo "  ‚ùå Failed to add {$column}: " . $e->getMessage() . "\n";
            }
        }
    }
    
    echo "\nüîç Checking conversations table structure...\n";
    
    // Check conversations table columns  
    $convColumns = Schema::getColumnListing('conversations');
    $requiredConvColumns = [
        'id', 'patient_id', 'admin_id', 'is_active', 'last_message_at',
        'archived_by_patient', 'archived_by_admin', 'created_at', 'updated_at'
    ];
    
    $missingConvColumns = [];
    
    foreach ($requiredConvColumns as $column) {
        if (in_array($column, $convColumns)) {
            echo "  ‚úÖ {$column} column exists\n";
        } else {
            $missingConvColumns[] = $column;
            echo "  ‚ùå {$column} column MISSING\n";
        }
    }
    
    if (!empty($missingConvColumns)) {
        echo "\nüîß Adding missing conversation columns...\n";
        
        foreach ($missingConvColumns as $column) {
            try {
                switch ($column) {
                    case 'archived_by_patient':
                    case 'archived_by_admin':
                        Schema::table('conversations', function ($table) use ($column) {
                            $table->boolean($column)->default(false);
                        });
                        echo "  ‚úÖ Added {$column} column\n";
                        break;
                    
                    case 'is_active':
                        Schema::table('conversations', function ($table) {
                            $table->boolean('is_active')->default(true);
                        });
                        echo "  ‚úÖ Added {$column} column\n";
                        break;
                    
                    case 'last_message_at':
                        Schema::table('conversations', function ($table) {
                            $table->timestamp('last_message_at')->nullable();
                        });
                        echo "  ‚úÖ Added {$column} column\n";
                        break;
                    
                    default:
                        echo "  ‚ö†Ô∏è  Skipped {$column} - manual intervention needed\n";
                        break;
                }
            } catch (Exception $e) {
                echo "  ‚ùå Failed to add {$column}: " . $e->getMessage() . "\n";
            }
        }
    }
    
    echo "\nüß™ Testing messaging system functionality...\n";
    
    // Test database queries that the messaging system uses
    try {
        $messageCount = DB::table('messages')->count();
        echo "  ‚úÖ Messages table accessible - {$messageCount} messages found\n";
        
        $conversationCount = DB::table('conversations')->count(); 
        echo "  ‚úÖ Conversations table accessible - {$conversationCount} conversations found\n";
        
        // Test a complex query similar to what the messaging controller uses
        $testQuery = DB::table('conversations')
            ->leftJoin('messages', 'conversations.id', '=', 'messages.conversation_id')
            ->select('conversations.*')
            ->whereNotNull('conversations.id')
            ->limit(1)
            ->get();
        
        echo "  ‚úÖ Complex joins working correctly\n";
        
        // Test reactions column specifically
        $testReaction = DB::table('messages')
            ->select('reactions')
            ->limit(1)
            ->get();
        
        echo "  ‚úÖ Reactions column accessible\n";
        
    } catch (Exception $e) {
        echo "  ‚ùå Database functionality test failed: " . $e->getMessage() . "\n";
        
        // Try to fix common issues
        echo "\nüîß Attempting to fix database issues...\n";
        
        try {
            // Clear any cached schema
            if (method_exists(Schema::class, 'flushCache')) {
                Schema::flushCache();
            }
            
            // Run migrations again to ensure everything is up to date
            Artisan::call('migrate', ['--force' => true]);
            echo "  ‚úÖ Re-ran migrations successfully\n";
            
        } catch (Exception $e) {
            echo "  ‚ùå Failed to fix: " . $e->getMessage() . "\n";
        }
    }
    
    echo "\nüéØ Testing Message Model functionality...\n";
    
    try {
        // Test if Message model can be instantiated
        $messageModel = new App\Models\Message();
        echo "  ‚úÖ Message model loads successfully\n";
        
        // Test relationships
        $testMessage = App\Models\Message::with('sender', 'conversation')->first();
        if ($testMessage) {
            echo "  ‚úÖ Message relationships working\n";
        } else {
            echo "  ‚ÑπÔ∏è  No messages found (this is ok for empty systems)\n";
        }
        
    } catch (Exception $e) {
        echo "  ‚ùå Message model error: " . $e->getMessage() . "\n";
    }
    
    echo "\nüéØ Testing Conversation Model functionality...\n";
    
    try {
        // Test if Conversation model can be instantiated
        $conversationModel = new App\Models\Conversation();
        echo "  ‚úÖ Conversation model loads successfully\n";
        
        // Test relationships
        $testConversation = App\Models\Conversation::with('patient', 'admin', 'messages')->first();
        if ($testConversation) {
            echo "  ‚úÖ Conversation relationships working\n";
        } else {
            echo "  ‚ÑπÔ∏è  No conversations found (this is ok for empty systems)\n";
        }
        
    } catch (Exception $e) {
        echo "  ‚ùå Conversation model error: " . $e->getMessage() . "\n";
    }
    
    echo "\nüèÅ Final Status Check...\n";
    
    // Final verification
    $finalColumns = Schema::getColumnListing('messages');
    $finalConvColumns = Schema::getColumnListing('conversations');
    
    $hasReactions = in_array('reactions', $finalColumns);
    $hasFileAttachment = in_array('has_attachment', $finalColumns);
    $hasArchiveFields = in_array('archived_by_patient', $finalConvColumns);
    
    if ($hasReactions && $hasFileAttachment && $hasArchiveFields) {
        echo "  üéâ ALL CHECKS PASSED! Messaging system should work correctly.\n";
        echo "\nüí° Next steps:\n";
        echo "  1. Clear application cache: php artisan cache:clear\n";
        echo "  2. Clear config cache: php artisan config:clear\n"; 
        echo "  3. Test messaging functionality on your site\n";
        echo "  4. Check browser console for any remaining JavaScript errors\n";
    } else {
        echo "  ‚ö†Ô∏è  Some issues remain:\n";
        if (!$hasReactions) echo "    - reactions column still missing\n";
        if (!$hasFileAttachment) echo "    - has_attachment column still missing\n";
        if (!$hasArchiveFields) echo "    - archive fields still missing\n";
        
        echo "\nüí° Manual fix needed - check your database directly\n";
    }
    
} catch (Exception $e) {
    echo "‚ùå CRITICAL ERROR: " . $e->getMessage() . "\n";
    echo "üìç File: " . $e->getFile() . "\n";
    echo "üìç Line: " . $e->getLine() . "\n\n";
    
    echo "üí° Troubleshooting steps:\n";
    echo "  1. Verify database connection in .env file\n";
    echo "  2. Check database permissions\n";
    echo "  3. Run: php artisan migrate --force\n";
    echo "  4. Run: php artisan cache:clear\n";
    echo "  5. Check Laravel logs for more details\n";
}

echo "\n‚ú® Script completed!\n";